---
title: "Rapid Sound Sequences Data Quality and Analysis"
author: "Iskra Todorova"
date: "2025-08-05"
output: 
 html_document:
    toc: true               # shows table of contents (agenda)
    toc_depth: 3            # how many heading levels to include
    toc_float: true         # makes the TOC float on the side
    code_folding: hide      # allows collapsing code blocks (default: shown)
    number_sections: true   # optional, section numbers
    theme: flatly           # optional Bootstrap theme (e.g., cerulean, journal)
    highlight: tango        # syntax highlight style
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

pkgs <- c("tidyverse",
         "ggplot2", # creating graphs
         "dplyr",
         "patchwork",
         "knitr",
         "viridis",
         "DT",
         "kableExtra",
         "lme4", 
         "emmeans",
         "lmerTest"
          )

# check if required packages are installed
installed_packages = pkgs %in% rownames(installed.packages())

# install packages if not installed
if (any(installed_packages == FALSE)) {
  install.packages(pkgs[!installed_packages])
}

lapply(pkgs, function(pkg) {
  if (!require(pkg, character.only = TRUE, quietly = TRUE)) {
    message(paste("Package", pkg, "not found."))
  }
})
```


```{r load_data, include=FALSE, warning=FALSE}
# Define paths (adjust to your project)

home_path <- "S:/KJP_Studien"
data_path <- "/LOCUS_MENTAL/6_Versuchsdaten/rapid_sound_sequences/"


# Load processed files
list.files(data_path)
df_et <- readRDS(paste0(home_path, data_path, "eyetracking_rss_c_optimized.rds"))
df_trial <- readRDS(paste0(home_path, data_path, "trialdata_rss_c_optimized.rds"))

# Check data structure
cat("Eye tracking data dimensions:", dim(df_et), "\n")
cat("Trial data dimensions:", dim(df_trial), "\n")
cat("Eye tracking columns:", paste(names(df_et), collapse = ", "), "\n")
cat("Trial columns:", paste(names(df_trial), collapse = ", "), "\n")

```

# Trial-level metrics 

To assess the quality of eye tracking data across trials, we calculated two key metrics: the gaze offset duration and the gaze nodata duration. These metrics represent, respectively, the total time within a trial that gaze deviated from the center (e.g., off-screen or invalid positions), and the time during which no gaze data was recorded.

We then normalized these durations by the total trial duration to express them as proportions. This allows for fair comparisons across trials of varying durations and helps to identify trials or participants with a high proportion of missing or unreliable gaze data.

## Gaze Offset and No DaTA
```{r , echo=TRUE}
# Check if required columns exist
required_cols <- c("gaze_offset_stimuli", "nodata_stimulus", "Stimulus_Duration", "Trial_Duration")
missing_cols <- setdiff(required_cols, names(df_trial))

if(length(missing_cols) > 0) {
  cat("Warning: Missing columns in df_trial:", paste(missing_cols, collapse = ", "), "\n")
  cat("Available columns:", paste(names(df_trial), collapse = ", "), "\n")
} else {
  df_trial <- df_trial %>%
    filter(Condition != "BASELINE") %>% 
    group_by(id, Trial.Number) %>%
    mutate(
      prop_offset_trial = gaze_offset_stimuli / Trial_Duration,
      prop_nodata_trial = nodata_stimulus / Trial_Duration,
    ) %>%
    ungroup()
  
  # Display summaries
  cat("Proportion of offset during stimuli:\n")
  print(summary(df_trial$prop_offset_trial))
  
  cat("\nProportion of no data during stimuli:\n")
  print(summary(df_trial$prop_nodata_trial))
}

```
```{r trial_quality_plots, echo=TRUE, fig.width=12, fig.height=8}
if(length(missing_cols) == 0) {
  # Create plots
  p1 <- ggplot(df_trial, aes(x = prop_nodata_trial)) +
    geom_histogram(bins = 30, fill = "steelblue", color = "white") +
    labs(title = "Proportion of No Data During Trial",
         x = "Proportion No Data", y = "Count") +
    theme_minimal()
  
  p2 <- ggplot(df_trial, aes(x = as.factor(id), y = prop_nodata_trial)) +
    geom_boxplot() +
    labs(title = "Proportion of Gaze No Data by Participant",
         x = "Participant", y = "Proportion No data") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  p3 <- ggplot(df_trial, aes(x = prop_offset_trial)) +
    geom_histogram(bins = 30, fill = "coral", color = "white") +
    labs(title = "Proportion of Gaze Offset During Trial",
         x = "Proportion Gaze Offset", y = "Count") +
    theme_minimal()
  
  p4 <- ggplot(df_trial, aes(x = as.factor(id), y = prop_offset_trial)) +
    geom_boxplot() +
    labs(title = "Proportion of Gaze Offset by Participant",
         x = "Participant", y = "Proportion Gaze Offset") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  # Combine plots
  (p1 + p2) / (p3 + p4)
}
```

## Trial, Stimulus and ISI Durations
```{r trial_quality_plots_2, echo=TRUE, fig.width=12, fig.height=8}

# Expected durations
expected_trial_duration <- 8  # e.g., 2s ISI + ~6s Stimulus
expected_stimulus_duration <- 6
expected_cartoon_duration <- 2

# Plot 1: Trial Duration
p_trial <- ggplot(df_trial, aes(x = Trial_Duration)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "white") +
  geom_vline(xintercept = expected_trial_duration, linetype = "dashed", color = "red", size = 1) +
  annotate("text", x = expected_trial_duration, y = 0, label = "Expected Duration",
           color = "red", angle = 0, vjust = -0.7, size = 3) +
  labs(title = "Distribution of Trial Duration", x = "Trial Duration (s)", y = "Count") +
  theme_minimal()

# Plot 2: Stimulus Duration
p_stimulus <- ggplot(df_trial, aes(x = Stimulus_Duration)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  geom_vline(xintercept = expected_stimulus_duration, linetype = "dashed", color = "red", size = 1) +
  annotate("text", x = expected_stimulus_duration, y = 0, label = "Expected Duration",
           color = "red", angle = 0, vjust = -0.7, size = 3) +
  labs(title = "Distribution of Stimulus Duration", x = "Stimulus Duration (s)", y = "Count") +
  theme_minimal()

# Plot 3: Cartoon (ISI) Duration
p_cartoon <- ggplot(df_trial, aes(x = cartoon_actual_duration)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  geom_vline(xintercept = expected_cartoon_duration, linetype = "dashed", color = "red", size = 1) +
  annotate("text", x = expected_cartoon_duration, y = 0, label = "Expected Duration",
           color = "red",angle = 0, vjust = -0.7, size = 3) +
  labs(title = "Distribution of Cartoon (ISI) Duration", x = "Cartoon Duration (s)", y = "Count") +
  theme_minimal()

p_trial /p_stimulus/p_cartoon
# Print plots one below another
#print(p_trial)
#print(p_stimulus)
#print(p_cartoon)
```
```{r}
# Filter trials longer than 9 seconds
trial_d_outliers <- df_trial %>%
  filter(Stimulus_Duration > 7)

# Optionally: select only relevant columns for inspection
df_outliers_summary <- trial_d_outliers %>%
  select(id, Trial.Number, Condition, Trial_Duration, Stimulus_Duration, cartoon_actual_duration)

# View the number of outliers
cat("Number of trials with stimulus duration > 6.5s:", nrow(trial_d_outliers), "\n")

# Display the summary table
knitr::kable(df_outliers_summary, caption = "Trials with Stimulus Duration > 7 Seconds")

df_trial <- df_trial %>%
  mutate(
    outlier_stim_dur = Stimulus_Duration > 6.5,
    outlier_trial_dur = Trial_Duration > 9,
    outlier_nodata = prop_nodata_trial > 0.2,
    outlier_offset = prop_offset_trial > 0.2,
    
    # Combine into overall flag
    is_outlier = outlier_stim_dur | outlier_trial_dur | outlier_nodata | outlier_offset,
    
    # Optional: Count how many conditions each trial violates
    outlier_score = outlier_stim_dur + outlier_trial_dur + outlier_nodata + outlier_offset
  )
df_combined_outliers <- df_trial %>%
  filter(is_outlier) %>%
  select(id, Trial.Number, Condition,
         Stimulus_Duration, Trial_Duration,
         cartoon_actual_duration,
         outlier_stim_dur, outlier_trial_dur,
         outlier_nodata, outlier_offset,
         outlier_score)

library(DT)
datatable(
  df_combined_outliers,
  options = list(
    pageLength = 10,
    scrollX = TRUE
  ),
  caption = "Trials Flagged as Outliers Based on Quality Criteria"
)
```

# Pupil Dilation (PD) Data 

Exploration of missing pupil data across participants and trials. We examined the proportion of missing PD data in the eye-tracking dataset.

```{r pupil_quality, echo=TRUE}
# Check if pd column exists
if(!"pd" %in% names(df_et)) {
  cat("Warning: 'pd' column not found in eye tracking data\n")
  cat("Available columns:", paste(names(df_et), collapse = ", "), "\n")
} else {
  na_threshold <- 0.2  # 20% threshold 
  
  # Summarize NA proportion per trial
  trial_na_summary <- df_et %>%
    group_by(id, Trial.Number) %>%
    summarise(
      total_samples = n(),
      na_count = sum(is.na(pd)),
      na_prop = mean(is.na(pd)),
      .groups = "drop"
    )
  
  # Inspect high-NA trials
  high_na_trials <- trial_na_summary %>%
    filter(na_prop > na_threshold)
  
  cat("Trials with >", na_threshold*100, "% missing PD data:\n")
  print(high_na_trials)
  
  # Overall data quality summary
  cat("\nOverall PD data quality:\n")
  cat("Total samples:", nrow(df_et), "\n")
  cat("Missing PD samples:", sum(is.na(df_et$pd)), "\n")
  cat("Overall missing rate:", round(mean(is.na(df_et$pd)) * 100, 2), "%\n")
}
```

```{r pupil_quality_plot, echo=TRUE, fig.width=12, fig.height=6}
if("pd" %in% names(df_et)) {
  # Plot pupil size over time with missing data indicators
  participant_data <- df_et %>% 
    mutate(sample_index = row_number())
  
  p10 <- ggplot(participant_data, aes(x = sample_index, y = pd)) +
    geom_line(color = "black", na.rm = TRUE, alpha = 0.7) +
    geom_point(data = subset(participant_data, is.na(pd)), 
               aes(x = sample_index, y = 0), 
               color = "red", shape = 4, size = 1) +
    labs(
      title = "Pupil Size Over Time (All Participants)",
      x = "Sample Index",
      y = "Pupil Diameter (mm)"
    ) +
    theme_minimal()
  
  # Distribution of missing data by participant
  missing_by_participant <- df_et %>%
    group_by(id) %>%
    summarise(
      missing_prop = mean(is.na(pd)),
      .groups = "drop"
    )
  
  p11 <- ggplot(missing_by_participant, aes(x = reorder(id, missing_prop), y = missing_prop)) +
    geom_col(fill = "steelblue") +
    labs(
      title = "Missing PD Data by Participant",
      x = "Participant ID",
      y = "Proportion Missing"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    geom_hline(yintercept = na_threshold, color = "red", linetype = "dashed")
  
  p10 / p11
}
```


## Gaze Position Quality Assessment

```{r gaze_preparation, echo=TRUE}
# Check if gaze columns exist
gaze_cols <- c("left_gaze_x", "right_gaze_x", "left_gaze_y", "right_gaze_y")
missing_gaze_cols <- setdiff(gaze_cols, names(df_et))

if(length(missing_gaze_cols) > 0) {
  cat("Warning: Missing gaze columns:", paste(missing_gaze_cols, collapse = ", "), "\n")
  cat("Available columns:", paste(names(df_et), collapse = ", "), "\n")
} else {
  # Calculate average gaze positions
  df_et$gaze_x_px <- (df_et$left_gaze_x + df_et$right_gaze_x) / 2
  df_et$gaze_y_px <- (df_et$left_gaze_y + df_et$right_gaze_y) / 2
  
  # Screen parameters
  monitor_width <- 2560
  monitor_height <- 1440
  half_width <- monitor_width / 2
  half_height <- monitor_height / 2
  
  cat("Gaze position summaries:\n")
  cat("X position: ")
  print(summary(df_et$gaze_x_px))
  cat("Y position: ")
  print(summary(df_et$gaze_y_px))
}
```

```{r gaze_plots, echo=TRUE, fig.width=12, fig.height=8}
# Function for plotting gaze with monitor boundaries
plot_gaze_with_boundaries <- function(data, half_width, half_height) {
  # Classify points as on/off monitor
  data$on_monitor <- abs(data$gaze_x_px) <= half_width & abs(data$gaze_y_px) <= half_height
  
  ggplot(data, aes(x = gaze_x_px, y = gaze_y_px)) +
    geom_point(aes(color = on_monitor), alpha = 0.3, size = 0.5) +
    scale_color_manual(values = c("FALSE" = "red", "TRUE" = "blue"),
                       labels = c("Off Monitor", "On Monitor")) +
    geom_rect(aes(xmin = -half_width, xmax = half_width,
                  ymin = -half_height, ymax = half_height),
              fill = NA, color = "green", linetype = "dashed", size = 1) +
    geom_vline(xintercept = 0, color = "black", linetype = "dotted") +
    geom_hline(yintercept = 0, color = "black", linetype = "dotted") +
    coord_fixed() +
    theme_minimal() +
    labs(
      title = "Gaze Points with Monitor Boundaries",
      x = "Gaze X (pixels)",
      y = "Gaze Y (pixels)",
      color = "Position"
    ) +
    theme(legend.position = "right")
}

if(length(missing_gaze_cols) == 0) {
  # Remove extreme outliers for better visualization
  df_plot <- df_et %>%
    filter(!is.na(gaze_x_px) & !is.na(gaze_y_px)) %>%
    filter(abs(gaze_x_px) < 3000 & abs(gaze_y_px) < 3000)  # Remove extreme outliers
  
  # Raw gaze distribution
  p1 <- ggplot(df_plot, aes(x = gaze_x_px, y = gaze_y_px)) +
    geom_hex(bins = 50) +
    scale_fill_viridis_c(option = "plasma", trans = "log10") +
    theme_minimal() +
    labs(
      title = "Gaze Position Distribution (Hex Plot)",
      x = "Gaze X (pixels)",
      y = "Gaze Y (pixels)",
      fill = "Log10 Count"
    ) +
    geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
    geom_hline(yintercept = 0, color = "red", linetype = "dashed")
  
  # Monitor boundaries plot
  p2 <- plot_gaze_with_boundaries(df_plot, half_width, half_height)
  
  p1 / p2
}

```

## Area of Interest (AOI) 

```{r aoi_analysis, echo=TRUE}
if(length(missing_gaze_cols) == 0) {
  # Define valid screen coordinates and AOI
  df_valid <- df_et %>%
    filter(
      !is.na(gaze_x_px) & !is.na(gaze_y_px) &
      abs(gaze_x_px) <= (monitor_width / 2) &
      abs(gaze_y_px) <= (monitor_height / 2)
    )
  
  # AOI definition (fixation cross area: 270x270 pixels centered at 0,0)
  aoi_threshold <- 135  # Half of 270 pixels
  
  df_valid$aoi_label <- with(df_valid,
    ifelse(
      abs(gaze_x_px) <= aoi_threshold & abs(gaze_y_px) <= aoi_threshold,
      "AOI", "Offset"
    )
  )
  
  # Calculate gaze distance from center
  df_valid$gaze_distance <- with(df_valid,
    sqrt(gaze_x_px^2 + gaze_y_px^2)
  )
  
  df_valid$gaze_deviated <- df_valid$gaze_distance > aoi_threshold
  
  # Summary statistics
  cat("AOI Analysis Results:\n")
  aoi_table <- table(df_valid$aoi_label)
  print(aoi_table)
  cat("\nProportion in AOI vs Offset:\n")
  print(prop.table(aoi_table) * 100)
  
  cat("\nGaze distance summary:\n")
  print(summary(df_valid$gaze_distance))
}
```

```{r aoi_plots, echo=TRUE, fig.width=12, fig.height=8}
if(length(missing_gaze_cols) == 0 && exists("df_valid")) {
  # AOI visualization
  p1 <- ggplot(df_valid, aes(x = gaze_x_px, y = gaze_y_px)) +
    geom_point(aes(color = aoi_label), alpha = 0.3, size = 0.8) +
    scale_color_manual(values = c("AOI" = "blue", "Offset" = "red")) +
    geom_rect(aes(xmin = -aoi_threshold, xmax = aoi_threshold,
                  ymin = -aoi_threshold, ymax = aoi_threshold),
              fill = NA, color = "blue", linetype = "dashed", size = 1) +
    coord_fixed() +
    theme_minimal() +
    labs(
      title = "Gaze Points: AOI vs Offset",
      x = "Gaze X (pixels)",
      y = "Gaze Y (pixels)",
      color = "Classification"
    )
  
  # Distance distribution
  p2 <- ggplot(df_valid, aes(x = gaze_distance)) +
    geom_histogram(bins = 50, fill = "skyblue", color = "white") +
    geom_vline(xintercept = aoi_threshold, color = "red", linetype = "dashed") +
    labs(
      title = "Distribution of Gaze Distance from Center",
      x = "Distance from Center (pixels)",
      y = "Count"
    ) +
    theme_minimal()
  
  p1 / p2
}
```
## Trial-Level AOI Quality Metrics

```{r trial_aoi_analysis, echo=TRUE}
if(exists("df_valid") && "Trial.Number" %in% names(df_valid)) {
  # Calculate AOI proportion per trial
  df_sum_aoi <- df_valid %>%
    filter(!is.na(Condition)) %>%
    group_by(id, Trial.Number, Condition) %>%
    summarise(
      aoi_prop = mean(aoi_label == "AOI", na.rm = TRUE),
      mean_gaze_distance = mean(gaze_distance, na.rm = TRUE),
      .groups = "drop"
    )
  
  # Overall summary by condition
  condition_summary <- df_sum_aoi %>%
    group_by(Condition) %>%
    summarise(
      mean_aoi_prop = mean(aoi_prop, na.rm = TRUE),
      sd_aoi_prop = sd(aoi_prop, na.rm = TRUE),
      mean_distance = mean(mean_gaze_distance, na.rm = TRUE),
      .groups = "drop"
    )
  
  cat("AOI proportion by condition:\n")
  print(condition_summary)
  
  # Identify problematic trials (low AOI proportion)
  low_aoi_threshold <- 0.5  # Less than 50% in AOI
  problematic_trials <- df_sum_aoi %>%
    filter(aoi_prop < low_aoi_threshold) %>%
    arrange(aoi_prop)
  
  cat("\nTrials with <50% gaze in AOI:\n")
  print(head(problematic_trials, 10))
} else {
  cat("Cannot perform trial-level AOI analysis - missing required data\n")
}
```
```{r trial_aoi_plots, echo=TRUE, fig.width=12, fig.height=6}
if(exists("df_sum_aoi")) {
  p1 <- ggplot(df_sum_aoi, aes(x = Condition, y = aoi_prop, fill = Condition)) +
    geom_boxplot() +
    geom_jitter(width = 0.2, alpha = 0.3) +
    theme_minimal() +
    labs(
      title = "AOI Proportion by Condition",
      x = "Condition",
      y = "Proportion of Gaze in AOI"
    ) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  p2 <- ggplot(df_sum_aoi, aes(x = id, y = aoi_prop)) +
    geom_boxplot() +
    labs(
      title = "AOI Proportion by Participant",
      x = "Participant ID",
      y = "Proportion of Gaze in AOI"
    ) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  p1 + p2
}
```


# Statistical Analysis
``` {r statistical_analysis, echo=TRUE, results= 'asis', message=FALSE, warning=FALSE}
if (all(c("pd_change", "Condition", "id") %in% names(df_trial))) {
  cat("### Mixed Effects Models for Pupil Dilation Change\n\n")

  ## --- Model 1: Full Condition Model ---
  cat("<details><summary><strong>Model 1: Condition Effects</strong></summary>\n\n")
  m1 <- lmer(pd_change ~ Condition + (1|id), data = df_trial)
  print(kable(anova(m1), digits = 3) %>%
          kable_styling(full_width = FALSE))
  cat("\n\n**Pairwise Comparisons (Tukey adjusted):**\n\n")
  print(kable(emmeans(m1, pairwise ~ Condition, adjust = "tukey")$contrasts, digits = 3) %>%
          kable_styling(full_width = FALSE))
  cat("\n</details>\n\n")

  ## --- Model 2: Control vs Transition ---
  df_trial <- df_trial %>%
    mutate(control_transition = case_when(
      Condition %in% c("REG10", "RAND20") ~ "Control",
      Condition %in% c("REG10-RAND20", "RAND20-REG1", "RAND20-REG10") ~ "Transition",
      TRUE ~ NA_character_
    ))

  if ("control_transition" %in% names(df_trial)) {
    cat("<details><summary><strong>Model 2: Control vs Transition</strong></summary>\n\n")
    m2 <- lmer(pd_change ~ control_transition + (1|id), data = df_trial)
    print(kable(anova(m2), digits = 3) %>%
            kable_styling(full_width = FALSE))
    cat("\n\n**Pairwise Comparisons (Tukey adjusted):**\n\n")
    print(kable(emmeans(m2, pairwise ~ control_transition, adjust = "tukey")$contrasts, digits = 3) %>%
            kable_styling(full_width = FALSE))
    cat("\n</details>\n\n")
  }

  ## --- Model 3: REG vs RAND Start ---
  df_trial <- df_trial %>%
    mutate(sequence_start = case_when(
      Condition %in% c("REG10", "REG10-RAND20") ~ "REG",
      Condition %in% c("RAND20", "RAND20-REG1", "RAND20-REG10") ~ "RAND",
      TRUE ~ NA_character_
    ))

  if ("sequence_start" %in% names(df_trial)) {
    cat("<details><summary><strong>Model 3: REG vs RAND Start</strong></summary>\n\n")
    m3 <- lmer(pd_change ~ sequence_start + (1|id), data = df_trial)
    print(kable(anova(m3), digits = 3) %>%
            kable_styling(full_width = FALSE))
    cat("\n\n**Pairwise Comparisons (Tukey adjusted):**\n\n")
    print(kable(emmeans(m3, pairwise ~ sequence_start, adjust = "tukey")$contrasts, digits = 3) %>%
            kable_styling(full_width = FALSE))
    cat("\n</details>\n\n")
  }

  ## --- Model 4: REG Subset ---
  REG_df <- subset(df_trial, Condition %in% c("REG10", "REG10-RAND20"))
  if (nrow(REG_df) > 0) {
    cat("<details><summary><strong>Model 4: REG-only Conditions</strong></summary>\n\n")
    m4 <- lmer(pd_change ~ Condition + (1|id), data = REG_df)
    print(kable(anova(m4), digits = 3) %>%
            kable_styling(full_width = FALSE))
    cat("\n\n**Pairwise Comparisons (Tukey adjusted):**\n\n")
    print(kable(emmeans(m4, pairwise ~ Condition, adjust = "tukey")$contrasts, digits = 3) %>%
            kable_styling(full_width = FALSE))
    cat("\n</details>\n\n")
  }

  ## --- Model 5: RAND Subset ---
  RAND_df <- subset(df_trial, Condition %in% c("RAND20", "RAND20-REG1", "RAND20-REG10"))
  if (nrow(RAND_df) > 0) {
    cat("<details><summary><strong>Model 5: RAND-only Conditions</strong></summary>\n\n")
    m5 <- lmer(pd_change ~ Condition + (1|id), data = RAND_df)
    print(kable(anova(m5), digits = 3) %>%
            kable_styling(full_width = FALSE))
    cat("\n\n**Pairwise Comparisons (Tukey adjusted):**\n\n")
    print(kable(emmeans(m5, pairwise ~ Condition, adjust = "tukey")$contrasts, digits = 3) %>%
            kable_styling(full_width = FALSE))
    cat("\n</details>\n\n")
  }

} else {
  cat("**Required variables for statistical analysis not found.**")
}
```

# Visualizations
```{r final_visualizations, echo=TRUE, fig.width=12, fig.height=8}
if(exists("df_valid") && "pd_corrected" %in% names(df_valid) && "ts_sequence" %in% names(df_valid)) {
  
  # --- Plot 1: Overall Condition Comparison ---
  p5 <- ggplot(df_valid, aes(x = ts_sequence, y = pd_corrected, color = Condition, fill = Condition)) +
    geom_smooth(se = TRUE, size = 1.2, alpha = 0.7) +
    theme_minimal() +
    ylim(c(-0.1, 0.4)) +
    labs(
      x = "Sequence Time (seconds)",
      y = "Pupil Dilation Corrected (mm)",
      title = "Pupil Dilation Changes Across Conditions"
    ) +  
    geom_vline(xintercept = 3, linetype = "dashed", color = "black", alpha = 0.7) +
    annotate("text", x = 3.2, y = 0.35, 
             label = "Transition", hjust = 0, fontface = "bold") +
    theme(
      legend.title = element_text(face = "bold", size = 12),
      legend.position = "right",
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 11),
      plot.title = element_text(hjust = 0.5, face = "bold", size = 14)
    )
  print(p5)

  # --- Plot 2: Faceted by condition_type ---
  if("condition_type" %in% names(df_valid)) {
    p6 <- ggplot(df_valid, aes(x = ts_sequence, y = pd_corrected, color = Condition, fill = Condition)) +
      geom_smooth(se = TRUE, size = 1.0, alpha = 0.7) +
      theme_minimal() +
      ylim(c(-0.1, 0.4)) +
      facet_wrap(~condition_type, scales = "free") +
      labs(
        x = "Sequence Time (seconds)",
        y = "Pupil Dilation Corrected (mm)",
        title = "Pupil Dilation: Control vs. Transition Trials"
      ) +  
      geom_vline(xintercept = 3, linetype = "dashed", color = "black", alpha = 0.7) +
      theme(
        legend.title = element_text(face = "bold", size = 10),
        legend.position = "bottom",
        axis.title = element_text(size = 11, face = "bold"),
        axis.text = element_text(size = 10),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
        strip.text = element_text(face = "bold")
      )
    print(p6)
  }

  # --- Plot 3: Faceted by initial_sequence ---
  if("initial_sequence" %in% names(df_valid)) {
    p7 <- ggplot(df_valid, aes(x = ts_sequence, y = pd_corrected, color = Condition, fill = Condition)) +
      geom_smooth(se = TRUE, size = 1.2, alpha = 0.7) +
      theme_minimal() +
      ylim(c(0, 0.3)) +
      facet_wrap(~initial_sequence) +
      labs(
        x = "Sequence Time (seconds)",
        y = "Pupil Dilation Corrected (mm)",
        title = "Pupil Dilation Change: Initial Sequence Comparison"
      ) +  
      geom_vline(xintercept = 3, linetype = "dashed", color = "black") +
      annotate("text", x = 3, 
               y = max(df_valid$pd_corrected, na.rm = TRUE) + 0.015, 
               label = "Transition", vjust = 0, fontface = "bold") +
      theme(
        legend.title = element_text(face = "bold", size = 12),
        legend.position = "right",
        axis.title = element_text(size = 12, face = "bold"),
        axis.text = element_text(size = 12),
        plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
        strip.text = element_text(face = "bold")
      )
    print(p7)
  }

} else {
  cat("Required variables for visualization not found.\n")
}

```

